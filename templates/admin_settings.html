{% extends "layout.html" %}

{% block title %}Admin Settings | QuoteZen{% endblock %}

{% block content %}
<div class="container-fluid p-4">

    <h2 class="mb-4">Welcome, {{ session.get('user_name', 'User') }}!</h2>

    <!-- Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body">
                    <h5 class="card-title">Pending Quotes</h5>
                    <h3 class="card-text">100+</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <h5 class="card-title">Completed Today</h5>
                    <h3 class="card-text">6</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body">
                    <h5 class="card-title">Projected Spend (MTD)</h5>
                    <h3 class="card-text">$15,600.00</h3>
                    <small class="text-light">-8% month over month</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body">
                    <h5 class="card-title">Active Carriers</h5>
                    <h3 class="card-text">18</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <h5 class="card-title">Active Companies</h5>
                    <h3 class="card-text" id="activeCompaniesCount">--</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Companies Section -->
    <div class="card border mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Company Profile</strong>
            <div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal">
                    <i class="fas fa-plus"></i> New Company
                </button>
                <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#companiesTable">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="collapse show" id="companiesTable">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>DUNS</th>
                            <th>Contact Name</th>
                            <th>Contact Phone</th>
                            <th>Address</th>
                            <th>Contact Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody 
                        id="companyTableBody" 
                        hx-get="{{ url_for('app_routes.api_company') }}" 
                        hx-trigger="load, refresh"
                        hx-target="this" 
                        hx-swap="innerHTML">
                        <!-- Dynamically loaded -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Carriers Table -->
    <div class="card border mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Carrier Network</strong>
            <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#carriersTable">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="collapse show" id="carriersTable">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Carrier Name</th>
                            <th>MC Number</th>
                            <th>DOT Number</th>
                            <th>Contact Name</th>
                            <th>Contact Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Carrier X</td>
                            <td>MC12345</td>
                            <td>DOT67890</td>
                            <td>Mike Johnson</td>
                            <td>mike@carrierx.com</td>
                            <td>(555) 555-5555</td>
                            <td>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>Carrier Y</td>
                            <td>MC54321</td>
                            <td>DOT09876</td>
                            <td>Emily Davis</td>
                            <td>emily@carriery.com</td>
                            <td>(555) 987-6543</td>
                            <td>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCompanyModalLabel">Add New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- HTMX FORM -->
                <form 
                    hx-post="{{ url_for('app_routes.api_company') }}" 
                    hx-target="#company-message"
                    hx-swap="innerHTML"
                    hx-indicator="#loading-spinner"
                >
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="duns_number" class="form-label">DUNS Number</label>
                            <input type="text" class="form-control" id="duns_number" name="duns" pattern="\d+" inputmode="numeric" required>
                            <div class="invalid-feedback">Please enter only numbers for DUNS Number.</div>
                        </div>
                        <div class="mb-3">
                            <label for="contact_name" class="form-label">Contact Name</label>
                            <input type="text" class="form-control" id="contact_name" name="contact_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact_phone" class="form-label">Contact Phone #</label>
                            <input type="tel" class="form-control" id="contact_phone" name="contact_phone" pattern="\d+" inputmode="numeric" required>
                            <div class="invalid-feedback">Please enter a valid phone number (digits only).</div>
                        </div>
                        <div class="mb-3">
                            <label for="company_address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="company_address" name="address" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact_email" class="form-label">Contact Email</label>
                            <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                            <div class="invalid-feedback">Please enter a valid email address.</div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Company</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Company Modal -->
    <div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="editCompanyModalLabel">Edit Company</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
    
            <form id="editCompanyForm"
            hx-target="#company-message"
            hx-swap="innerHTML"
            hx-indicator="#edit-loading-spinner"
            >
            <div class="modal-body">
                <input type="hidden" name="id" id="edit_company_id">
                <div class="mb-3">
                <label for="edit_company_name" class="form-label">Company Name</label>
                <input type="text" class="form-control" id="edit_company_name" name="company_name" required>
                </div>
                <div class="mb-3">
                <label for="edit_duns_number" class="form-label">DUNS Number</label>
                <input type="text" class="form-control" id="edit_duns_number" name="duns" required pattern="\d+">
                </div>
                <div class="mb-3">
                <label for="edit_contact_name" class="form-label">Contact Name</label>
                <input type="text" class="form-control" id="edit_contact_name" name="contact_name" required>
                </div>
                <div class="mb-3">
                <label for="edit_contact_phone" class="form-label">Contact Phone</label>
                <input type="text" class="form-control" id="edit_contact_phone" name="contact_phone" required pattern="\d+">
                </div>
                <div class="mb-3">
                <label for="edit_company_address" class="form-label">Address</label>
                <input type="text" class="form-control" id="edit_company_address" name="address" required>
                </div>
                <div class="mb-3">
                <label for="edit_contact_email" class="form-label">Contact Email</label>
                <input type="email" class="form-control" id="edit_contact_email" name="contact_email" required>
                </div>
            </div>
    
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Update Company</button>
            </div>
            <div id="edit-loading-spinner" class="htmx-indicator">
                <span class="spinner-border spinner-border-sm text-primary"></span> Updating...
            </div>
            <div id="company-message" class="mt-2"></div>
            </form>
        </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this company?
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>
  
</div>

<script>
    // Injected from Flask to use in dynamic HTML
    const companyApiUrl = "{{ url_for('app_routes.api_company') }}";

    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        const config = evt.detail.requestConfig;

        console.log("🔍 HTMX Request Config:");
        console.log("➡️  Method:", config.verb);
        console.log("➡️  Path:", config.path);
        console.log("➡️  Parameters:", config.parameters);

        if (config.verb === "put") {
            console.log("PUT request is being sent as expected.");
        } else if (config.verb === "post") {
            console.log("POST request is being sent as expected.");
        } else if (config.verb === "delete") {
            console.log("DELETE request is being sent as expected.");
        } else {
            console.warn(`Unexpected HTTP method: ${config.verb}`);
        }
    });


    document.body.addEventListener("htmx:afterOnLoad", function(event) {
        const target = event.target;
        const responseText = event.detail.xhr.responseText;

        if (target.id !== "companyTableBody") return;

        try {
            const companies = JSON.parse(responseText);

            if (!Array.isArray(companies) || companies.length === 0) {
                target.innerHTML = `<tr><td colspan="7">No companies registered</td></tr>`;
                return;
            }

            document.getElementById("activeCompaniesCount").textContent = companies.length;

            const rows = companies.map(company => {
                const user = company.user || {};

                return `
                    <tr>
                        <td>${company.company_name}</td>
                        <td>${company.duns}</td>
                        <td>${user.first_name || "N/A"}</td>
                        <td>${user.phone || "N/A"}</td>
                        <td>${user.address || "N/A"}</td>
                        <td>${user.email || "N/A"}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" data-id="${company.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    hx-delete="${companyApiUrl}/${company.id}"
                                    hx-confirm="Are you sure you want to delete this company?"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join("");

            target.innerHTML = rows;

        } catch (err) {
            target.innerHTML = `<tr><td colspan="7" class="text-danger">Error parsing data</td></tr>`;
            console.error("Failed to parse companies JSON:", err);
        }
    });

    document.body.addEventListener("htmx:afterRequest", function (event) {
        const { path, verb } = event.detail.requestConfig;
        const target = document.querySelector("#company-message");

        if (path.includes("/api/company")) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);

                if (response.status === "success") {
                    if (verb === "delete") {
                        target.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                Company deleted successfully!
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                    } else {
                        htmx.trigger("#companyTableBody", "refresh");

                        const modalId = verb === "post" ? "addCompanyModal" : "editCompanyModal";
                        const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
                        if (modal) modal.hide();

                        document.querySelector(`#${modalId} form`).reset();

                        target.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                Company ${verb === "post" ? "added" : "updated"} successfully!
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                    }
                } else if (response.status === "error") {
                    let errorMessage = response.message;

                    if (errorMessage.includes("duplicate key value")) {
                        errorMessage = "A company with this DUNS number already exists. Please use a unique DUNS number.";
                    }

                    showMessage(errorMessage, "danger");
                }
            } catch (err) {
                console.error("Failed to parse response:", err);
            }
        }
    });


    document.body.addEventListener("click", async function (e) {
        const btn = e.target.closest("button[data-id]");
        const deleteBtn = event.target.closest("button.btn-danger");

        if (btn && btn.classList.contains("btn-primary")) {
            const id = btn.getAttribute("data-id");
            const editForm = document.getElementById("editCompanyForm");
            editForm.setAttribute("hx-put", `/api/company/${id}`);
            htmx.process(editForm);
            try {
                // Fetch company data from API
                const res = await fetch(`${companyApiUrl}/${id}`);
                const data = await res.json();

                // Fill form fields
                document.getElementById("edit_company_id").value = data.id;
                document.getElementById("edit_company_name").value = data.company_name;
                document.getElementById("edit_duns_number").value = data.duns;
                document.getElementById("edit_contact_name").value = data.user.first_name || "";
                document.getElementById("edit_contact_phone").value = data.user.phone || "";
                document.getElementById("edit_company_address").value = data.user.address || "";
                document.getElementById("edit_contact_email").value = data.user.email || "";

                // Set form action for PUT
                console.log("hx-put set to:", `/api/company/${id}`);

                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById("editCompanyModal"));
                editModal.show();

            } catch (err) {
                console.error("Error loading company for edit:", err);
                showMessage("Failed to load company data.", "danger");
            }
        }

        if (deleteBtn && deleteBtn.hasAttribute("hx-delete")) {
            event.preventDefault();

            // Store the URL and row to delete later
            companyToDelete = deleteBtn.getAttribute("hx-delete");
            deleteRowElement = deleteBtn.closest("tr");

            // Show the modal
            const deleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
            deleteModal.show();
        }
    });
    
    document.addEventListener("htmx:configRequest", function(evt) {
        const form = evt.target.closest("form");
        if (form && !form.checkValidity()) {
            evt.preventDefault(); 
            form.classList.add("was-validated");
        }
    });

    document.getElementById("confirmDeleteBtn").addEventListener("click", async function () {
        if (!companyToDelete || !deleteRowElement) return;

        const confirmModal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
        confirmModal.hide(); // Close the modal

        try {
            const res = await fetch(companyToDelete, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            // Option 1: Handle 204 No Content
            if (res.status === 204) {
                htmx.trigger("#companyTableBody", "refresh");
                showMessage("Company deleted successfully!", "success");
                return;
            }

            // Option 2: Handle JSON response
            const data = await res.json();
            if (res.ok && data.status === "success") {
                htmx.trigger("#companyTableBody", "refresh");
                showMessage("Company deleted successfully!", "success");
            } else {
                throw new Error(data.message || "Deletion failed");
            }
        } catch (err) {
            console.error("Delete error:", err);
            showMessage("Failed to delete company: " + err.message, "danger");
        } finally {
            companyToDelete = null;
            deleteRowElement = null;
        }
    });


    function showMessage(message, type = "info") {
        const target = document.querySelector("#company-message");
        if (!target) return;

        target.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        setTimeout(() => {
            target.innerHTML = "";
        }, 5000);
    }
    
</script>

{% endblock %}
