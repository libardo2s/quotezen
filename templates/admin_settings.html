{% extends "layout.html" %}

{% block title %}Admin Settings | QuoteZen{% endblock %}

{% block content %}
<div class="container-fluid p-4">

    <h2 class="mb-4">Welcome, {{ session.get('user_name', 'User') }}!</h2>

    <!-- Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body">
                    <h5 class="card-title">Pending Quotes</h5>
                    <h3 class="card-text">100+</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <h5 class="card-title">Completed Today</h5>
                    <h3 class="card-text">6</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body">
                    <h5 class="card-title">Projected Spend (MTD)</h5>
                    <h3 class="card-text">$15,600.00</h3>
                    <small class="text-light">-8% month over month</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body">
                    <h5 class="card-title">Active Carriers</h5>
                    <h3 class="card-text">18</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Companies Section -->
    <div class="card border mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Company Profile</strong>
            <div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal">
                    <i class="fas fa-plus"></i> New Company
                </button>
                <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#companiesTable">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="collapse show" id="companiesTable">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>DUNS</th>
                            <th>Contact Name</th>
                            <th>Contact Phone</th>
                            <th>Address</th>
                            <th>Contact Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="companyTableBody" hx-get={{ url_for('app_routes.api_company') }} hx-trigger="load" hx-target="this" hx-swap="innerHTML">
                        <!-- Companies will be loaded dynamically here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Carriers Table -->
    <div class="card border mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Carrier Network</strong>
            <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#carriersTable">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="collapse show" id="carriersTable">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Carrier Name</th>
                            <th>MC Number</th>
                            <th>DOT Number</th>
                            <th>Contact Name</th>
                            <th>Contact Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Carrier X</td>
                            <td>MC12345</td>
                            <td>DOT67890</td>
                            <td>Mike Johnson</td>
                            <td>mike@carrierx.com</td>
                            <td>(555) 555-5555</td>
                            <td>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>Carrier Y</td>
                            <td>MC54321</td>
                            <td>DOT09876</td>
                            <td>Emily Davis</td>
                            <td>emily@carriery.com</td>
                            <td>(555) 987-6543</td>
                            <td>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add New Company Modal -->
    <div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCompanyModalLabel">Add New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- HTMX FORM -->
                <form 
                    hx-post="{{ url_for('app_routes.api_company') }}" 
                    hx-target="#company-message"
                    hx-swap="innerHTML"
                    hx-indicator="#loading-spinner"
                >
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="duns_number" class="form-label">DUNS Number</label>
                            <input type="text" class="form-control" id="duns_number" name="duns" pattern="\d+" inputmode="numeric" required>
                            <div class="invalid-feedback">Please enter only numbers for DUNS Number.</div>
                        </div>
                        <div class="mb-3">
                            <label for="contact_name" class="form-label">Contact Name</label>
                            <input type="text" class="form-control" id="contact_name" name="contact_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact_phone" class="form-label">Contact Phone #</label>
                            <input type="tel" class="form-control" id="contact_phone" name="contact_phone" pattern="\d+" inputmode="numeric" required>
                            <div class="invalid-feedback">Please enter a valid phone number (digits only).</div>
                        </div>
                        <div class="mb-3">
                            <label for="company_address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="company_address" name="address" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact_email" class="form-label">Contact Email</label>
                            <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                            <div class="invalid-feedback">Please enter a valid email address.</div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Company</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="htmx-indicator">
        <span class="spinner-border spinner-border-sm text-primary"></span> Saving...
    </div>
    <div id="company-message" class="mt-2"></div>
</div>

<script>
    document.body.addEventListener("htmx:afterOnLoad", function(event) {
        const target = event.target;
        const responseText = event.detail.xhr.responseText;

        // Ensure we're only targeting the company table
        if (target.id !== "companyTableBody") return;

        try {
            const companies = JSON.parse(responseText);

            if (!Array.isArray(companies)) {
                target.innerHTML = `<tr><td colspan="7">No data available</td></tr>`;
                return;
            }

            const rows = companies.map(company => {
                const user = company.user || {};

                return `
                    <tr>
                        <td>${company.company_name}</td>
                        <td>${company.duns}</td>
                        <td>${user.first_name || "N/A"}</td>
                        <td>${user.phone || "N/A"}</td>
                        <td>${user.address || "N/A"}</td>
                        <td>${user.email || "N/A"}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" data-id="${company.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    hx-delete="{{ url_for('app_routes.api_company')}}/${company.id}"
                                    hx-confirm="Are you sure you want to delete this company?"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join("");

            target.innerHTML = rows;

        } catch (err) {
            target.innerHTML = `<tr><td colspan="7" class="text-danger">Error parsing data</td></tr>`;
            console.error("Failed to parse companies JSON:", err);
        }
    });

    document.body.addEventListener("htmx:afterRequest", function (event) {
        const { path, verb } = event.detail.requestConfig;
        if (verb === "post" && path.includes("/api/company")) {
            console.log(event)
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.status === "success") {
                htmx.trigger("#companyTableBody", "load");
                const modal = bootstrap.Modal.getInstance(document.getElementById("addCompanyModal"));
                if (modal) modal.hide();
                document.querySelector("#addCompanyModal form").reset();
            }
        }
    });

    document.addEventListener("htmx:configRequest", function(evt) {
        const form = evt.target.closest("form");
        if (form && !form.checkValidity()) {
            evt.preventDefault();  // Cancel HTMX request
            form.classList.add("was-validated");
        }
    });
</script>

{% endblock %}
